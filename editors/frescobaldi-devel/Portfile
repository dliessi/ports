# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           python 1.0

name                frescobaldi-devel
conflicts           frescobaldi
version             20130902
revision            2
set git_branch      979b3e971a2e7acbe676af39b7ecb2a62dfe412c
categories          editors python
maintainers         gmail.com:davide.liessi openmaintainer
description         A LilyPond sheet music text editor
long_description    Frescobaldi is a LilyPond sheet music text editor. \
                    It aims to be powerful, yet lightweight and easy to use.
homepage            http://www.frescobaldi.org/
platforms           darwin
supported_archs     noarch
license             GPL-2+

fetch.type          git
git.url             https://github.com/wbsoft/frescobaldi.git
git.branch          ${git_branch}

build {}

depends_run-append  port:portmidi

variant python26 conflicts python27 description {Use python 2.6} {
    python.default_version  26
    depends_run-append      port:py${python.default_version}-pyqt4 \
                            port:py${python.default_version}-python-poppler-qt4
}
variant python27 conflicts python26 description {Use python 2.7} {
    python.default_version  27
    depends_run-append      port:py${python.default_version}-pyqt4 \
                            port:py${python.default_version}-python-poppler-qt4
}
if {![variant_isset python26]} {
    default_variants        +python27
}

variant app description {Make application bundle} {
    depends_build-append    port:py${python.default_version}-cx_Freeze
    
    patchfiles-append       patch-frescobaldi_app-mainwindow.py.patch \
                            patch-frescobaldi_app-hyphendialog.py.patch \
                            patch-frescobaldi_app-language_names-__init__.py.patch \
                            patch-frescobaldi_app-lilydoc-network.py.patch \
                            patch-frescobaldi_app-po-__init__.py.patch \
                            patch-frescobaldi_app-po-setup.py.patch
    
    post-destroot {
        set app_bundle      ${worksrcpath}/Frescobaldi.app
        set app_contents    ${app_bundle}/Contents
        set app_macos       ${app_contents}/MacOS
        set app_resources   ${app_contents}/Resources
        
        file mkdir ${app_macos}
        
        set infopliststrings \
"/* Localized versions of Info.plist keys */

CFBundleName = \"Frescobaldi\";
CFBundleDisplayName = \"Frescobaldi\";

NSHumanReadableCopyright = \"Copyright © 2008-2012 Wilbert Berendsen.\";
"
        foreach l {cs de en es fr gl it nl pl pt ru tr uk} {
            file mkdir ${app_resources}/${l}.lproj
            set fileID [ open "${app_resources}/${l}.lproj/InfoPlist.strings" "w" ]
            puts -nonewline ${fileID} ${infopliststrings}
            close ${fileID}
        }
        
        set infoplist \
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">
<plist version=\"1.0\">
<dict>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleIdentifier</key>
	<string>org.frescobaldi.frescobaldi</string>
	<key>CFBundleSignature</key>
	<string>????</string>
	<key>CFBundleExecutable</key>
	<string>Frescobaldi</string>
	<key>CFBundleDisplayName</key>
	<string>Frescobaldi</string>
	<key>CFBundleVersion</key>
	<string>${version}</string>
	<key>CFBundleName</key>
	<string>Frescobaldi</string>
	<key>CFBundleIconFile</key>
	<string>frescobaldi.icns</string>
	<key>NSHumanReadableCopyright</key>
	<string>Copyright © 2008-2012 Wilbert Berendsen.</string>
</dict>
</plist>
"
        set fileID [ open "${app_contents}/Info.plist" "w" ]
        puts -nonewline ${fileID} ${infoplist}
        close ${fileID}
        
        exec ${prefix}/bin/cxfreeze-${python.branch} \
            ${destroot}${frameworks_dir}/Python.framework/Versions/${python.branch}/bin/frescobaldi \
            --target-dir ${app_macos} --no-copy-deps --target-name Frescobaldi
        
        file copy ${filespath}/frescobaldi.icns ${app_resources}
        
        file mkdir ${destroot}/Applications
        file copy ${app_bundle} ${destroot}${applications_dir}       
    }
}

notes \
"You may want to install fluidsynth and obtain a SoundFont
in order to have audio output from frescobaldi's MIDI output.

You will need to select fluidsynth's MIDI input port
in frescobaldi's MIDI settings (in Preferences)
while fluidsynth is running."
